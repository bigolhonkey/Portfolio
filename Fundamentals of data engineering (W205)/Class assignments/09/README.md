# Summary of tasks for assignment 09 
## MIDS W205 Spring 2019
## Author : Suhas Gupta
## Docker Containers Used: mids, zookeeper, kafka

## Summary of tasks : 

    - Spun a cluster of containers zookeeper, kafka and mids
    - Create a topic called "events" to log logs for calls made by the game API to the web server 
    - Developed two simple Flask game APIs that interact with the user and a webserver on its two ends 
    - Logged the web server events to kafka and read them through kafkacat

## Container cluster configuration file (docker-compose.yml)

```yml
---
version: '2'
services:
zookeeper:
image: confluentinc/cp-zookeeper:latest
environment:
ZOOKEEPER_CLIENT_PORT: 32181
ZOOKEEPER_TICK_TIME: 2000
expose:
- "2181"
- "2888"
- "32181"
- "3888"
extra_hosts:
- "moby:127.0.0.1"

kafka:
image: confluentinc/cp-kafka:latest
depends_on:
- zookeeper
environment:
KAFKA_BROKER_ID: 1
KAFKA_ZOOKEEPER_CONNECT: zookeeper:32181
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092
KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
expose:
- "9092"
- "29092"
extra_hosts:
- "moby:127.0.0.1"

mids:
image: midsw205/base:0.1.8
stdin_open: true
tty: true
volumes:
- ~/w205:/w205
expose:
- "5000"
ports:
- "5000:5000"
extra_hosts:
- "moby:127.0.0.1"

```

## Source code 1 of flask game application

```python
#!/usr/bin/env python
from flask import Flask
app = Flask(__name__)

@app.route("/")
def default_response():
    return "\nThis is the default response. No purchase or sale!\n"

@app.route("/purchase_a_sword")
def purchase_sword():
    return "\nSword Purchased!\n"

@app.route("/sell_a_sword")
def sell_sword():
    return "\nSword Purchased!\n"
```

## Source code 2 of flask game application

```python
#!/usr/bin/env python
from kafka import KafkaProducer
from flask import Flask
app = Flask(__name__)
event_logger = KafkaProducer(bootstrap_servers='kafka:29092')
events_topic = 'events'

@app.route("/")
def default_response():
event_logger.send(events_topic, 'default'.encode())
return "\nThis is the default response!\n"

@app.route("/purchase_a_sword")
def purchase_sword():
# business logic to purchase sword
# log event to kafka
event_logger.send(events_topic, 'purchased_sword'.encode())
return "\nSword Purchased!\n"
```

## Execution Summary

### 1. I brought up a cluster with kafka, mids and zookeper containers. 
    - Kafka is a unified, high throughput and low latency platform for handling real time data feeds
    - Zookeper is distributed configuration management service 
    - The MIDS container is developed for use with W205 course with essential libraries for the coursework

```
docker-compose up -d
```

### 2. I created a kafka topic called "events" that can be used to log the web events generated by the game API using the Flask micro web service.

```
docker-compose exec kafka kafka-topics --create --topic events --partitions 1 --replication-factor 1 --if-not-exists --zookeeper zookeeper:32181
```

Output: 
```
Created topic "events".
```

### 3. Next we wrote up a simple game API in python to use with the Flask micro webservice. The source code is included above as code 1 above.

### 4. I ran the game API using the FLASK micro web service:

```
docker-compose exec mids env FLASK_APP=/w205/assignment-09-suhasgupta791/game_api.py flask run
```
### 5. Next step was to test out the game API

The events are generated by the user using the game API (e.g. on a mobile platform). The app interacts with the FLASK micro webservice and generated web events that are logged on the server. 

```
docker-compose exec mids curl http://localhost:5000/
docker-compose exec mids curl http://localhost:5000/
docker-compose exec mids curl http://localhost:5000/purchase_a_sword
docker-compose exec mids curl http://localhost:5000/
docker-compose exec mids curl http://localhost:5000/purchase_a_sword
docker-compose exec mids curl http://localhost:5000/purchase_a_sword
```
#### Monitoring the web server will show us the events logged by the web service: 

Output: 
```
127.0.0.1 - - [16/Mar/2019 05:08:40] "GET / HTTP/1.1" 200 -
127.0.0.1 - - [16/Mar/2019 05:08:42] "GET / HTTP/1.1" 200 -
127.0.0.1 - - [16/Mar/2019 05:08:46] "GET /purchase_a_sword HTTP/1.1" 200 -
127.0.0.1 - - [16/Mar/2019 05:08:52] "GET / HTTP/1.1" 200 -
127.0.0.1 - - [16/Mar/2019 05:08:60] "GET /purchase_a_sword HTTP/1.1" 200 -
127.0.0.1 - - [16/Mar/2019 05:08:65] "GET /purchase_a_sword HTTP/1.1" 200 -
```
### 6. Next, I ran the more complex game API source code 2 from above. 

This game code adds kafka to the mix. I created an event logger to send events to kafka topic "events" created earlier. Each transaction by the user on the game API is then sent to the kafka event logger that we can then read using kafkacat.

```
docker-compose exec mids env FLASK_APP=/w205/assignment-09-suhasgupta791/game_api_with_kafka.py flask run
```

I generated game events with the following commands:
```
docker-compose exec mids curl http://localhost:5000/
docker-compose exec mids curl http://localhost:5000/purchase_a_sword
docker-compose exec mids curl http://localhost:5000/purchase_a_sword
```

#### Read the event logs using kafkacat that were send to kafka using Kafka Producer in the game API source code.
```
docker-compose exec mids bash -c "kafkacat -C -b kafka:29092 -t events -o beginning -e"
```

Output: 
```
default
purchased_sword
purchased_sword
```
