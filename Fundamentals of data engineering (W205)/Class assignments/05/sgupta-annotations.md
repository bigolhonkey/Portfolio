# Annotations for assignment 05 MIDS W205

## 1. Getting the redis and mids container to talk to each other in a docker cluster 

### Below I change directory to  W205/redis-cluster and spin a cluster after copying the example docker-compose.yml file from the class content from previous week

```
mkdir ~/w205/redis-cluster
cd ~/w205/redis-cluster
cp ../course-content/05-Storing-Data-II/example-1-docker-compose.yml docker-compose.yml
```

### The comand below starts the cluster with redis and mids containers:

```
docker-compose up -d
```

### We can check the containers active in the cluster using the following command:

```
docker-compose ps
```

### To look at the logs of the redis container we can use the following command:
```
docker-compose logs redis
```

### In order to run a bash shell we can issue the following command on the mids container:
```
docker-compose exec mids bash
```

### Once inside the mids container executing a bash shell, we can run the python interpreter as follows:

```
ipython
```

### Now we can try redis data structure store system in python using the following simple commands. The r.keys() commands shows us the set keys (none at the moment)

```python
import redis
r = redis.Redis(host='redis', port='6379')
r.keys()
exit
```

### To exit the active mids container we can simply use the exit command

```
exit
```

### In order to tear down the cluster stack, we can use the following command: 

```
docker-compose down
```

### Below we verify if the cluster is down 

```
docker-compose ps
```

### We can also check for any stray containers using the follwing command: 

```
docker ps -a
```
### Download the bike share data table from google 

```
cd ~/w205
pwd
curl -L -o trips.csv https://goo.gl/QvHLKe
```

## 2. Using some basic redis functions to put and get keys in python 

### Bring up a new cluster with mids and redis containers 

```
docker-compose up -d
```

### Lets start jupyter notebook in the mids container

```
docker-compose exec mids jupyter notebook --no-browser --port 8888 --ip 0.0.0.0 --allow-root
```

### We copy the token generated by the command above and paste it in a browser to run redis python commands (see submitted file : redis_commands_jupyter_notebook.ipynb)

### Once we are done, we can drop the cluster

```
docker-compose down
```

## 3. Tracking user activity

### Bring up a cluster 

```
docker-compose up -d
```

### Check the mids container logs to get the jupyter notebook token

```
docker-compose logs mids
```

### I copied the Jupyter Notebook token and replace the 0.0.0.0 with the droplet IP address to open the notebook in a browser.

### I opened a new Python3 notebook to run the redis python commands

### We use the google BigQuery data downloaded above and analyze the data

### The redis data store structure is used to set keys from the SF bike trips data frame 

### Afterwards, we get the keys from the redis data structure emulating a user activity tracker

```python
import redis
import pandas as pd

trips=pd.read_csv('trips.csv')

date_sorted_trips = trips.sort_values(by='end_date')

date_sorted_trips.head()

for trip in date_sorted_trips.itertuples():
      print(trip.end_date, '', trip.bike_number, '', trip.end_station_name)

current_bike_locations = redis.Redis(host='redis', port='6379')

current_bike_locations.keys()

for trip in date_sorted_trips.itertuples():
      current_bike_locations.set(trip.bike_number, trip.end_station_name)
      
current_bike_locations.keys()
current_bike_locations.get('92')
```

### Finally we drop the cluster using the command below

```
docker-compose down
```
